Redesigning Beatmap Diffculty Calculation System along with Scoring and pp calculation system in osu!mania
==========================================================================================================
(인체공학적 알고리즘
현 알고리즘 문제점들을 몇가지 패턴들을 보이며 지적
그대로 그 점들을 해결하는 방안들을 제시)
난이도 분포가 다르다 (예: 영야초 7키)

설령 약간 계수 tuning이 잘 안돼있다 하더라도
모두 같은 조건이니 fairness는 보장; 등수 가르는 데에는 큰 지장이 없다
불렙 기피 현상이 좀 덜해지겠지


# Overall
파트별로 Reading * Strain + Stamina


## 1. Strain
말 그대로 진짜 손가락의 긴장도
1. Lane마다 누르는 난이도가 다르다.
예) 1->1 이 3->3 보다 어렵다
2. 이전에 누른 Lane에 따라 난이도가 다르다. (가정: 가까이 있을수록 트릴 불리)
예) 1->2->1 이 1->3->1 보다 어렵다
3. 같이 누르는 다른 Lane에 따라 난이도가 다르다. (가정: 가까이 있을수록 동시타 유리)
예) 1&4 가 1&2보다 어렵다 
4. 마지막으로 치고나서 곧 다시 치면, 그 lane은 strain 보너스. 
5. 같이 쳐야 하는 노트의 lane이 붙어있으면 strain 감소.

- 다양한 경우 모두 파악 (2^4)^2 = 256
- 빠르면, (OD에 따라) 난이도 상승
- 홀수키에 대해서, 엄지는 쉬운 손으로 판정; min()


### 현재 손가락 별 strain
(엄지부터 소지까지)
1.2 1.0 1.1 1.25 1.5 (1/2 version)
1.4 1.0 1.2 1.5 2.0
- 새끼손가락은 다른 lane에 따른 strain 감소 없게.

### Game the Algorithm
계산에 따라서, 6동시타가 7동시타보다 strain 클 수 있다.
이때, 6키 연타인데 7키 연타처럼 친다면? 
-> 7키 동시타처럼 쳤을 때, 200 이상의 판정이 나온다면 min 값 취하기.

### LN
- 롱놋 떼진 동안 해당 Note strain 보너스 취소. (다시 누르면 다시 인정)
- 엄지부터 약지까지 1 ~ 4라고 하였을 때
    * 엄지: 모두 1.1x
    * 이외: 바깥쪽 바로 옆 손가락: 1.2x (A)
    *       그 외 바깥쪽 손가락: 1.15x (B)
    *       안쪽 손가락: 1.1x       (C)        
- 한 손에 눌려있는 롱놋 개수에 대한 추가 strain.
    * strain*= 1 + n*0.05
- 롱놋 시작할때 같이 치는 노트들은 LN 보너스 없음
    * 끝날때 치는 노트들은 필요할 듯, or 약간이라도.
- 떼는 거에도 strain 부여
    * 일반 롱노트: 0.4
    * 노트 같은 롱놋 (a.k.a 숏놋): 따로 떼는 strain 없이 처음 노트에 약 1.1x부여 


### Strain second adjustment
(이거 때문에라도 고정ms 도입해야하지 않을까?) -> 이거에만 적용해볼 수도 있겠는데, 변속곡 처리 힘드니 그냥 ms체제로 가기로. 
- 옆 손가락 눌린지 얼마 안됐으면 strain 증가 (트릴 검사)
- 옆 손가락 같이 눌리면 strain 감소 (동시타 검사)
- 현 손가락 눌린지 얼마 안 됐으면 strain 증가 (연타 검사)
-> 연타는 손 자체를 점프해야 해서 어려움
- 단, OD를 고려하여, 동시타로 뭉갤 수 있으면 트릴 효과 감소

총 2개의 strain multiplier graph: 트릴과 연타.
1. 트릴
동시에 쳤을 때 miss나는 만큼 차이가 있을때 트릴 보정 최대
동시에 쳤을 때 300이 나기 시작하면, 가까울수록 동시타 보정; strain 패널티
0.75~1.4
2. 연타
일정 지점까지는 1x
OD를 고려하여, 임계 시간 이내의 연속된 노트가 등장할 경우 strain 증가; 최대 3

기본적으로 OD가 높을수록 시간 여유롭게?
OD가 높을수록 유리할 수도 있을까? miss 판정 범위가 다를테니까
이빨 빠진 동시타로 Test할 필요가 있음.



트릴 그래프에서 동시타 패널티도 동시에 적용
그리고 각 보정은 양측 라인에 중복해서 거는걸로.


### 화두
- (o) 붙어 있는 동시타에 대하여, 6키보다는 7키가 더 strain이 크게 계산되게 할 것. 많이 증가되진 않게. 
- 3계단같이 트릴이 여러 Lane에 걸쳐 있을 경우.
(처리 잘 될 것으로 소박히 기대)
- 같은 딜레이여도, 완전 계단은 쉽고 scattered 는 어렵다
- 4키에서, lane 배치를 DF JK 에서 S F  J L 로 바꾸었을 때, strain 증가가 있어야함 (그래야 사람들이 덜 선호하는 이유가 설명되니까)

## 2. Stamina
Trace of *Strain*. 
일시정지를 걸면 stamina 측정에 그만큼 zero 값이 반영.
맵 시작 시간부터 맵이 끝날 때까지 반영; 
(strain이 지나치게 낮으면 추가 panelty 도입 가능성)

stamina=0.9*stamina+0.12(strain at current unit time)
계수 합이 1이 넘는게 point다.

멈출 경우, 이전 파트의 "stamina" 파트가 시간에 따라 감소
이에 Adjusted Score 역시 자연스럽게 감소
그러나, 이를 또 악용하여 나머지 파트의 weight 가 올라가는 일이 없도록
scale 이 역으로 증가함 없이 감소만 하도록 조정.
(오투잼에서는 멈추는 기능이 아예 없으므로 떨어질 일이 없다)


## 3. Reading
(normal notes는, strain이 reading을 압도한다고 생각하여 고려 안함)
(LN 역시 잠시 고려하였으나, 마찬가지로 strain이 대부분 클 것으로 예상하여 고려 안함)
이 부분에서 다루는 건 SV.

같은 패턴에 대해, SV가 어떻게 주어지냐에 따라 최대 1.08 ~ 1.12 or 1.19(HDFL) 배 부여.

노트 당 노출시간의 비율 * 이전 노트들 노출시간의 비율 경향 (마지막 노트 100개)

리인카네이션같이 저속 시작은 어떡하지
사실 저속 자체가 어려운건데.
"main 속도"를 정하는게 좋을거 같음


## 4. Overall Difficulty
- 멱급수합 후 scaling factor
-> 가중치를 일정히 감소시킬지, 초반 몰빵으로 할지 아니면 중간 후하게 줄지는 이후 결정
- 어려운 구간에 점수가 좀더 배점이 되므로, 대부분 이전보다 점수가 내려갈 것.
-> base: hitbonus를 5:5 로 두지말고 한 7:3으로 바꿀까? 
- 단위 패턴, 크기 고정으로 갈지 크기 가변으로 할지.
현재 400ms, 만약 크기 가변이라면 반마디 (2박)로 잡을듯.
2박이 400ms이 되려면 -> BPM 300
BPM120: 한박 500ms
BPM360: 세박 500ms

Effective Score
------------------------
대부분의 적당히 쉬운 구간 + 최소한의 어려운 구간으로
스코어 abusing을 막기 위한 방안

기존 점수 시스템 대비 점수를 뻥튀기 할지 안 할지는 고민. (1.0 ~ 1.2x; 기본적으로 이게 도입되면 점수가 전반적으로 낮아질 것.)
멈추면 stamina 감소, 비례배분 재분배 없이 그냥 분배치 감소.


난이도 측정 방식이 바뀔 때마다 동일한 리플레이에 대해서 점수가 바뀜
서버에 submit 날짜 기준으로 어떤 버전의 난이도 측정 알고리즘 썼는지는 알 수 있음
->이후 알고리즘 바뀌는거 생각해서
스코어 제출과 함께
각 노트 hit을 뭐로 했는지 기록
(13번째 노트는 320 쳤습니다  등)
# 아! 롱노트 친 상태로 치고 있는지 등도 기록해놔야함
# 아! 어떤 롱노트 치고 있는지도 기록해놔야함!
# 아! 어떤 시점에서 얼마나 일시정지 하고 있는지도 기록해야함

replay있는게 best이고
->그냥 다 기록하자. 용량 얼마 안할듯
10만명이 5만플을 제출한다고 하자.
10^5 * 5*10^4 = 5*10^9 (5G)
 json 하나에 최대 5KB라 치자.
25TB. 조금 크지만, 핸들 불가능할 정도는 아니다.


구간 별로 난이도 계산해서 점수 분배할 게 아니라..
그냥 점수를 아예 '노트' 수준에서 하는건?
즉, 각 노트 쳤을 때 점수= (strain) / (총 strain)
(처음에는 effective score가 높은 쪽의 점수로 pp계산할 걸 생각)

## 기존 기록들에 대한 처리
맵 별 점수-pp 일대일 함수 생각해볼 수 있을듯 (구버전 점수 전용 함수)
- "맵 내 난이도 분포 심할수록" pp에 패널티
- "점수가 애매할수록" pp에 패널티

Mods idea
-------------------------
RD 아이디어
이제 RD도 난이도에 변화를 주니까,
시드 저장하고 플레이.
(근데 여전히 unranked가 더 매력있어보임)

HR 아이디어
이제 OD와 Reading 이 난이도에 변화를 주니까,
SV 변화율 1.4배 키우기
(아니면 하락걸면 모든 노트가 숏롱놋이 되게)
(+하락하였을 때 멈추면 패널티 크게)
(아니면 하락걸면 공푸어 생기게)


Others
-----------------------------
+오투잼식 계산법 추가
이지 노말 하드, 체력 증가/감소량 고려하여 난이도 계산

HP 낮을수록, 저점수에서 pp 패널티?
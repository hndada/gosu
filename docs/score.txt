4+1 판정 체계 (beatmania, ez2dj)
KOOL    16
COOL    15
GOOD    10
BAD     4
MISS    0

SS All Cool & 997000~ (KC 비율 10:1 기준 997159)
S 900k~
A 800k~
B 700k~
C 600k~
D ~600k

확도 삭제 - 대신 득점률을 보여줌
in detail에서 보여주긴 할 거임

일시정지하면 스코어 submit 안되게

미스 내면 감점시키기
노트 4개에 해당하는 만큼의 점수 감점

보너스 스코어 패널티 회복
미스 났을 때 Bonus Score penalty를 -inf(-100) 로 하지않기
(기존: 2 for MAX, 1 for 300)
#strain 기반
대충 일반적인 어려운 맵에서 max:300이 3:1로 발생한다고 해보자
그럼 보너스 회복량은 평균 기존 방식 기준 2*3/4+1*1/4 = 1.75
모든 노트의 strain 평균에 해당하는 값을 1.75로 산정
(아니면 그냥 평균을 1로)
그뒤로 선형 관계로 회복량 산출
쳤으면 해당 값 그대로 주기
못쳤으면 0 0 -4 -10 -25
최대 -100

체력 감소는 일정하게 (3%)
체력 회복은 strain과 비례하게

롱노트
head: a note
body: no score, 누르면 조금씩 회복, 떼면 조금씩 회복의 4배 감소
body가 있는 구간의 다른 노트는 롱노트 보너스를 받음
tail: 길이에 따른 score, 체력에 별도 영향 없음
v￣느낌으로 그래프 형성 (최소 strain 되는 길이가 중간에 존재)


미스 나는 경우
1. 아예 다 놓쳤을 경우
2. 중간에 놓쳤을 경우
    2-1. 다시 이을 경우
3. 끝나도 안 놓았을 경우

- 미스는 점수체력 모두 4-5배의 패널티를 갖기로.

- 놓치고 있는 롱노트있으면 보너스 점수 회복안되게

- 패널티는 롱놋 놓은 그 순간에 바로 발생 (처음부터 끝까지 이어져있는 롱놋의 경우, 끝에서 발생시키면 의미가 없어짐)

- 중간에 다시 이어도 tail 점수는 복구 안됨


해야할 것: score, clear 계산기
replay parser 한번 시도해보고 안되면 그냥 손으로
-> replay 실제 데이터, 의외로 뭔가 이상하므로
별도로 내 데이터 타입을 만들도록 하자

단순 replay에서는, 일반 노트는 누른 직후 떼었다고 가정
롱노트는 slice of pairs: [누른 시각, 뗀 시각] - 중간에 떼고 판정 범위 내에 다시 누른다면 슬라이스 길이 추가  

각 노트, hit 판정 범위 내에서 쳤을 때의 시각 or slice of pairs을 기록 

패널티는 노트 누른 직후 반영
같은 시간대라면, 거의 그럴 일이 없을 것이므로 편의 상 column 순서대로.

(연쇄적.
235번째 노트, 판정 BAD :: Bonus: 34, HP: 79
236번째 노트, 판정 COOL :: Bonus: 34.8, HP: 79.33
237번째 노트(롱노트), 판정 KOOL, KOOL :: (보너스, HP) -> 단순replay에서는 롱노트를 한개로 취급)



노트 순으로 할 게 아니라 (롱노트가 여러 시간에 걸쳐 있으니까)
이벤트 발생할 때마다 bonus랑 hp 계산하는 게 좋을 듯
롱놋 지속 증가의 경우, 비례 증가이니 처음과 끝만 계산한 뒤 선형으로 연출

time, (key), strain, judge -> bonus, hp
time, (key), strain=0 or x, judge=on/off -> bonus+=0, hp (for 롱노트)
off인데 judge가 miss가 아니면 롱놋 종료
헤드 따로, 바디 따로. => 아예 바디를 따로 관리할까? hp만 보게 (고려)
time, (pause key), strain=(일시정지 시간), judge=on/off 으로 일시정지 관리 가능할 듯

score (및 clear) 계산기 ㅆㄱㄴ
1. sr 최종 책정 방식, 다가오는 5개에 대해 앞 구간 strain 합 일부 적용
1-1. 빈 구간 넣을 경우, 어떻게 대처? -> 노트가 거의 없는 수준이면 효과 거의 없게 식 걸기 (다소 복잡하겠지만 가능)
2. LN strain project
3. implementing score/hp simulator

길이가 상당히 긴 롱노트의 꼬리 노트에 strain을 너무 많이 주면, 롱노트 한개로 끝나는 단순한 패턴인데 엄청나게 올라갈 수 있음
-> 점수를 base + lengthBonus 로 나눠서 끝 노트에 점수는 다소 많이 주되,
해당 구간에선 base만 주는건 어떨까?
(그 외 것들
1. 롱노트와 같이 나오는 노트들의 보너스로 길이 실현 (이게 좋을거 같음)
2. 롱노트 안에서 strain 분배)

노트, 얼마나 오래 누르고 있는지 봤는데 쉬우면 금방 떼고 안쉬우면 좀더 오래 쥐고 있다

동일 판정이어도, 노트별 난이도가 다르기 때문에 gosu에서는 점수가 달라지는게 당연지사

노트 판정 조건: 마지막 state가 idle(off)이면서 판정 범위 내에 pressed(on).
롱노트 판정 조건: missed가 아니고 마지막 state가 on이면서 꼬리 판정 범위 내에서 unpressed(off)
롱노트 시작 이후, 꼬리 판정 범위 이전에 off가 발생하면 꼬리 miss 판정.

노트 판정은 즉시 처리 후 score queue에. 한번 판정 처리된 노트는 다시 보지 않는다.
아예 안 눌러 미스가 발생한 경우 미스 한계 범위 넘어가면서 판정 처리. 이외에는 대기.

안친지 97ms (OD0기준 '50' 경계선) 넘어간 시점에서 replay 기록 남김. (OD10에선 30ms 빨리 기록됨)

staged 노트의 array가 있어야 할 것 같다
곧 칠 예정이거나 이미 쳤어야 하는 범위 이내 노트들 및 롱노트의 경우 안 끝난 노트

한번 루프 돌때마다 하는 거
리플레이 액션을 읽는다
현재 state로 리플레이 액션을 업데이트한다
staged 스캔, 현재 및 이전 state들로 판정 처리->score queue에 업데이트.
staged에서 done 된 노트를 업데이트
마지막으로 현재 state를 이전 state에 복사한다

closure, function 단위 init정도로 보면 될듯 (초깃값 설정)

홀드 tail 까지 판정 완료되고 나면 눌러도 회복 x (사실 이미 notes에 없다)
홀드 tail도 판정 받을 때에는 체력 변화가 있게 하자

롱놋 켜져있을 때에는 언제나 회복. 꺼지고 미스 한계까지 누르고 있으면 미스.



생각해보니까 베이스, 보너스를 나눌 필요가 없음
(max)*(패널티 차감된 비율) 하는게 더 깔끔


틀릴시 체력감소 평균을 3으로
체력감소 및 회복 모두 strain(aggregate)에 비례하게
(이미지: 6개꽝꽝)

배드나면, 풀콤사망같은 이상한 일이 안생기게 차지도 떨어지지도 않게 (어떻게 될지 나도 잘모르겠다 ㅋㅋ)

미스에의한 체력감소는 맥스에의한 체력증가의 4배가되게
16 기준 100, BAD 기준 0으로 비례하게.

Ghost, 넣는게 맞는 것 같기도 해
(이미지: 아주 같은 조건에서 뭉갠 애랑 덜 뭉갠 애)
미스의 절반 정도 깎이게 하겠음

카르마 스코어에 log2 걸까도 생각했다가 말았음